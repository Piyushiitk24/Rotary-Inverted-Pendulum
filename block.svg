<svg xmlns="http://www.w3.org/2000/svg" width="1400" height="850" viewBox="0 0 1400 850">
  <defs>
    <marker id="arrow" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
      <path d="M0,0 L0,6 L9,3 z" fill="#000" />
    </marker>
    <style type="text/css">
      <![CDATA[
        text { font-family: Helvetica, Arial, sans-serif; font-size: 14px; }
        .label { font-weight: bold; font-size: 16px; }
        .signal { font-style: italic; font-size: 13px; fill: #333; }
        .unit { font-size: 11px; fill: #666; }
        .block { fill: #f4f4f4; stroke: #333; stroke-width: 2px; }
        .plant-block { fill: #e1edff; stroke: #004a99; stroke-width: 2px; }
        .sensor-block { fill: #fff2cc; stroke: #d6b656; stroke-width: 2px; }
        .controller-block { fill: #ddf4dd; stroke: #38761d; stroke-width: 2px; }
        .process-block { fill: #fff; stroke: #333; stroke-width: 1.5px; stroke-dasharray: 5,2; }
        .sum { fill: #fff; stroke: #333; stroke-width: 2px; }
        line, path { stroke: #000; stroke-width: 1.5px; fill: none; marker-end: url(#arrow); }
        .dashed-line { stroke-dasharray: 6,4; }
        .boundary-line { stroke: #999; stroke-width: 1px; stroke-dasharray: 8,8; marker-end: none; }
        .boundary-text { font-size: 18px; font-weight: bold; fill: #999; }
      ]]>
    </style>
  </defs>

  <rect x="0" y="0" width="1400" height="850" fill="#ffffff"/>
  <text x="700" y="40" text-anchor="middle" font-size="24" font-weight="bold">Rotary Inverted Pendulum Control System Diagram</text>
  <text x="700" y="70" text-anchor="middle" font-size="18" fill="#666">Cascade Control: Inner PID (Pendulum Stabilization) + Outer Bias (Base Centering)</text>

  <line x1="50" y1="620" x2="1350" y2="620" class="boundary-line"/>
  <text x="70" y="610" class="boundary-text">Discrete-Time Controller (T_s = 8 ms)</text>
  <text x="70" y="645" class="boundary-text">Continuous-Time Plant &amp; Physics</text>

  <rect x="1050" y="670" width="220" height="100" rx="5" ry="5" class="plant-block"/>
  <text x="1160" y="710" text-anchor="middle" class="label">PLANT</text>
  <text x="1160" y="735" text-anchor="middle">Stepper Motor +</text>
  <text x="1160" y="755" text-anchor="middle">Rotary Arm &amp; Pendulum</text>

  <line x1="1270" y1="700" x2="1350" y2="700" marker-end="none"/>
  <text x="1310" y="695" text-anchor="middle" class="signal">θ_p(t)</text>
  <line x1="1270" y1="750" x2="1350" y2="750" marker-end="none"/>
  <text x="1310" y="745" text-anchor="middle" class="signal">θ_m(t)</text>


  <rect x="1050" y="540" width="140" height="60" rx="5" ry="5" class="sensor-block"/>
  <text x="1120" y="565" text-anchor="middle">Pendulum Sensor</text>
  <text x="1120" y="585" text-anchor="middle">(AS5600 + ZOH)</text>

  <rect x="1200" y="540" width="140" height="60" rx="5" ry="5" class="sensor-block"/>
  <text x="1270" y="565" text-anchor="middle">Motor Sensor</text>
  <text x="1270" y="585" text-anchor="middle">(AS5600 + ZOH)</text>

  <path d="M 1350 700 L 1370 700 L 1370 510 L 1120 510 L 1120 540" class="dashed-line"/>
  <path d="M 1350 750 L 1390 750 L 1390 490 L 1270 490 L 1270 540" class="dashed-line"/>

  <line x1="1050" y1="570" x2="1000" y2="570"/>
  <rect x="840" y="540" width="160" height="60" rx="5" ry="5" class="block"/>
  <text x="920" y="565" text-anchor="middle">Offset Correction &amp;</text>
  <text x="920" y="585" text-anchor="middle">Normalization</text>

  <line x1="840" y1="570" x2="750" y2="570"/>
  <text x="800" y="565" text-anchor="middle" class="signal">θ_p[k]</text>
  <text x="800" y="585" text-anchor="middle" class="unit">(deg)</text>

  <line x1="1200" y1="570" x2="1160" y2="570" marker-end="none"/>
  <path d="M 1160 570 L 1160 460 L 1000 460"/>
  <rect x="840" y="430" width="160" height="60" rx="5" ry="5" class="block"/>
  <text x="920" y="455" text-anchor="middle">Offset Correction &amp;</text>
  <text x="920" y="475" text-anchor="middle">Sign Flip (-)</text>

  <line x1="840" y1="460" x2="400" y2="460"/>
  <text x="600" y="455" text-anchor="middle" class="signal">θ_m[k]</text>
  <text x="600" y="475" text-anchor="middle" class="unit">(deg)</text>

  <path d="M 750 570 L 750 520 L 700 520"/>
  <rect x="560" y="490" width="140" height="60" rx="5" ry="5" class="block"/>
  <text x="630" y="515" text-anchor="middle">Derivative Est.</text>
  <text x="630" y="535" text-anchor="middle">&amp; LPF (α=0.2)</text>
  <line x1="560" y1="520" x2="500" y2="520"/>
  <text x="530" y="515" text-anchor="middle" class="signal">θ̇_p[k]</text>
  <text x="530" y="535" text-anchor="middle" class="unit">(deg/s)</text>


  <path d="M 400 460 L 350 460 L 350 310 L 380 310"/>
  <rect x="380" y="280" width="180" height="60" rx="5" ry="5" class="controller-block"/>
  <text x="470" y="305" text-anchor="middle">Deadzone (|θ|>10°)</text>
  <text x="470" y="325" text-anchor="middle">&amp; Gain (-Kp_center)</text>

  <line x1="380" y1="310" x2="340" y2="310" marker-end="none"/>
  <path d="M 340 310 L 340 230 L 380 230"/>
  <rect x="380" y="210" width="120" height="40" rx="5" ry="5" class="block"/>
  <text x="440" y="235" text-anchor="middle">Saturation (±5°)</text>
  <text x="320" y="225" class="signal">Bias</text>

  <text x="80" y="185" class="signal">Upright Ref</text>
  <text x="80" y="205" class="label">0°</text>
  <circle cx="150" cy="195" r="20" class="sum"/>
  <text x="150" y="200" text-anchor="middle" font-size="20">+</text>
  <text x="150" y="170" text-anchor="middle" font-size="20" fill="#999">+</text>

  <line x1="110" y1="195" x2="130" y2="195"/> <path d="M 500 230 L 530 230 L 530 140 L 150 140 L 150 175"/> <text x="230" y="185" class="signal">θ_p*[k]</text>
  <text x="230" y="205" class="unit">(Desired)</text>

  <circle cx="300" cy="380" r="20" class="sum"/>
  <text x="275" y="385" text-anchor="middle" font-size="20">-</text>
  <text x="300" y="410" text-anchor="middle" font-size="20">+</text>

  <path d="M 170 195 L 300 195 L 300 355" /> <path d="M 750 570 L 300 570 L 300 405" /> <text x="335" y="370" class="signal">e[k]</text>
  <text x="335" y="390" class="unit">(deg)</text>

  <line x1="320" y1="380" x2="360" y2="380" marker-end="none"/>
  <path d="M 360 380 L 360 300 L 400 300"/> <path d="M 360 380 L 360 400 L 400 400"/> <rect x="400" y="280" width="60" height="40" rx="5" ry="5" class="controller-block"/>
  <text x="430" y="305" text-anchor="middle">Kp</text>

  <rect x="400" y="380" width="100" height="40" rx="5" ry="5" class="controller-block"/>
  <text x="450" y="400" text-anchor="middle">Integrator</text>
  <text x="450" y="415" text-anchor="middle">(Clamp ±15)</text>
  <rect x="520" y="380" width="60" height="40" rx="5" ry="5" class="controller-block"/>
  <text x="550" y="405" text-anchor="middle">Ki</text>
  <line x1="500" y1="400" x2="520" y2="400"/>

  <path d="M 500 520 L 480 520 L 480 480 L 460 480"/>
  <rect x="360" y="460" width="100" height="40" rx="5" ry="5" class="block"/>
  <text x="410" y="485" text-anchor="middle">Clamp (±200)</text>
  <rect x="280" y="460" width="60" height="40" rx="5" ry="5" class="controller-block"/>
  <text x="310" y="485" text-anchor="middle">-Kd</text>
  <line x1="360" y1="480" x2="340" y2="480"/>

  <circle cx="650" cy="380" r="25" class="sum"/>
  <text x="630" y="385" text-anchor="middle" font-size="20">+</text>
  <text x="650" y="415" text-anchor="middle" font-size="20">+</text>
  <text x="650" y="350" text-anchor="middle" font-size="20">+</text>

  <path d="M 460 300 L 650 300 L 650 355"/> <path d="M 580 400 L 650 400 L 650 385" marker-end="none"/> <path d="M 280 480 L 260 480 L 260 550 L 650 550 L 650 405"/> <text x="690" y="375" class="signal">u[k]</text>
  <text x="690" y="395" class="unit">(deg-equiv)</text>


  <line x1="675" y1="380" x2="720" y2="380"/>
  <rect x="720" y="350" width="110" height="60" rx="5" ry="5" class="block"/>
  <text x="775" y="375" text-anchor="middle">Gain</text>
  <text x="775" y="395" text-anchor="middle">1 / 0.225</text>

  <text x="855" y="375" class="signal">ω_cmd[k]</text>
  <text x="855" y="395" class="unit">(steps/s)</text>

  <line x1="830" y1="380" x2="880" y2="380"/>
  <rect x="880" y="350" width="140" height="60" rx="5" ry="5" class="block"/>
  <text x="950" y="375" text-anchor="middle">Saturation</text>
  <text x="950" y="395" text-anchor="middle">(±MAX_HZ)</text>

  <line x1="1020" y1="380" x2="1080" y2="380"/>
  <rect x="1080" y="350" width="160" height="60" rx="5" ry="5" class="block"/>
  <text x="1160" y="375" text-anchor="middle">Soft Limits</text>
  <text x="1160" y="395" text-anchor="middle">(Brake based on θ_m)</text>

  <path d="M 400 460 L 1160 460 L 1160 410" class="dashed-line"/>


  <line x1="1240" y1="380" x2="1300" y2="380" marker-end="none"/>
  <path d="M 1300 380 L 1300 630 L 1050 630 L 1050 680"/>

  <text x="1320" y="630" text-anchor="middle" class="signal">Stepper Speed</text>
  <text x="1320" y="650" text-anchor="middle" class="signal">Command</text>
  <text x="1320" y="670" text-anchor="middle" class="unit">Hz + Dir (ZOH)</text>

</svg>