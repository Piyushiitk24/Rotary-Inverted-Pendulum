#include <Arduino.h>
#include <Wire.h>
#include <SoftwareWire.h>
#include <AS5600.h>
#include <AccelStepper.h>

// Stepper Motor
#define STEP_PIN 5
#define DIR_PIN  6
#define EN_PIN   7
AccelStepper stepper(AccelStepper::DRIVER, STEP_PIN, DIR_PIN);

// Pendulum Sensor on Hardware I2C
AS5600 as5600_pendulum(&Wire);

// Motor Sensor on Software I2C
#define MOTOR_SDA_PIN 22
#define MOTOR_SCL_PIN 24
#define AS5600_ADDRESS 0x36
#define AS5600_RAW_ANGLE_REG 0x0C
#define AS5600_STATUS_REG 0x0B
SoftwareWire motorWire(MOTOR_SDA_PIN, MOTOR_SCL_PIN);

// Motor settings
#define MOTOR_SPEED 1000
#define MOTOR_ACCEL 2000

// Calibration data
float pendulumZeroAngle = 0.0;
float motorZeroAngle = 0.0;
float motorMinAngle = 0.0;  // Left edge
float motorMaxAngle = 0.0;  // Right edge
bool isCalibrated = false;

// Current readings
float pendulumAngle = 0.0;
float motorAngle = 0.0;
long motorSteps = 0;

// Sensor I2C helpers
uint16_t readAS5600Angle(SoftwareWire &wire) {
  wire.beginTransmission(AS5600_ADDRESS);
  wire.write(AS5600_RAW_ANGLE_REG);
  if (wire.endTransmission() != 0) return 0;
  wire.requestFrom(AS5600_ADDRESS, 2);
  if (wire.available() >= 2) {
    uint8_t high = wire.read();
    uint8_t low = wire.read();
    return (high << 8) | low;
  }
  return 0;
}

bool detectAS5600Magnet(SoftwareWire &wire) {
  wire.beginTransmission(AS5600_ADDRESS);
  wire.write(AS5600_STATUS_REG);
  if (wire.endTransmission() != 0) return false;
  wire.requestFrom(AS5600_ADDRESS, 1);
  if (wire.available()) {
    uint8_t status = wire.read();
    return (status & 0x20) != 0;
  }
  return false;
}

void updateSensorReadings() {
  // Read pendulum angle (Hardware I2C)
  uint16_t pendulum_raw = as5600_pendulum.readAngle();
  float pendulum_deg = (pendulum_raw * 360.0) / 4096.0;
  
  // Read motor angle (Software I2C)
  uint16_t motor_raw = readAS5600Angle(motorWire);
  float motor_deg = (motor_raw * 360.0) / 4096.0;
  
  // Store relative to zero
  pendulumAngle = pendulum_deg - pendulumZeroAngle;
  motorAngle = motor_deg - motorZeroAngle;
  motorSteps = stepper.currentPosition();
  
  // Normalize pendulum angle to -180 to +180
  while (pendulumAngle > 180.0) pendulumAngle -= 360.0;
  while (pendulumAngle < -180.0) pendulumAngle += 360.0;
  
  // Normalize motor angle to -180 to +180
  while (motorAngle > 180.0) motorAngle -= 360.0;
  while (motorAngle < -180.0) motorAngle += 360.0;
}

void printSensorReadings() {
  updateSensorReadings();
  
  Serial.print("Pendulum: ");
  Serial.print(pendulumAngle, 2);
  Serial.print("° \t Motor: ");
  Serial.print(motorAngle, 2);
  Serial.print("° \t Steps: ");
  Serial.println(motorSteps);
}

void printCalibrationData() {
  Serial.println("\n=== CALIBRATION DATA ===");
  Serial.print("Pendulum Zero: ");
  Serial.print(pendulumZeroAngle, 2);
  Serial.println("°");
  Serial.print("Motor Zero: ");
  Serial.print(motorZeroAngle, 2);
  Serial.println("°");
  
  if (isCalibrated) {
    Serial.print("Motor MIN (Left Edge): ");
    Serial.print(motorMinAngle, 2);
    Serial.println("°");
    Serial.print("Motor MAX (Right Edge): ");
    Serial.print(motorMaxAngle, 2);
    Serial.println("°");
    Serial.print("Total Range: ");
    Serial.print(motorMaxAngle - motorMinAngle, 2);
    Serial.println("°");
  } else {
    Serial.println("Edges not yet calibrated.");
  }
  Serial.println("========================\n");
}

void printMainMenu() {
  Serial.println("\n╔════════════════════════════════════════════╗");
  Serial.println("║   STEP-BY-STEP CALIBRATION & TESTING       ║");
  Serial.println("╚════════════════════════════════════════════╝");
  Serial.println("\n--- STEP 1: SET ZERO POSITION ---");
  Serial.println("1 - Set Zero Position (position arm at center, pendulum up)");
  Serial.println("\n--- STEP 2: VERIFY SENSORS ---");
  Serial.println("2 - Live Sensor Test (continuously display sensor readings)");
  Serial.println("\n--- STEP 3: FIND EDGE LIMITS ---");
  Serial.println("3 - Record LEFT Edge (manually move arm to left limit)");
  Serial.println("4 - Record RIGHT Edge (manually move arm to right limit)");
  Serial.println("5 - Show Calibration Data");
  Serial.println("\n--- STEP 4: TEST MOTOR MOVEMENT ---");
  Serial.println("6 - Test Motor Within Limits (move to edges and back)");
  Serial.println("7 - Manual Jog CW (+50 steps)");
  Serial.println("8 - Manual Jog CCW (-50 steps)");
  Serial.println("9 - Return to Zero");
  Serial.println("\n--- UTILITIES ---");
  Serial.println("0 - I2C Bus Scan");
  Serial.println("C - Clear calibration data");
  Serial.println("S - Stop current operation");
  Serial.println("\n════════════════════════════════════════════");
  Serial.print("Enter choice: ");
}

void setZeroPosition() {
  Serial.println("\n╔════════════════════════════════════════════╗");
  Serial.println("║        STEP 1: SET ZERO POSITION           ║");
  Serial.println("╚════════════════════════════════════════════╝");
  Serial.println("\nINSTRUCTIONS:");
  Serial.println("1. Manually move the motor arm to the CENTER position");
  Serial.println("2. Position the pendulum STRAIGHT UP (vertical, 0°)");
  Serial.println("3. Press 'Z' to set this as the zero position");
  Serial.println("4. Press 'X' to cancel\n");
  
  while (true) {
    if (Serial.available() > 0) {
      char c = Serial.read();
      if (c == 'z' || c == 'Z') {
        // Set motor zero
        stepper.setCurrentPosition(0);
        
        // Read and set pendulum zero
        uint16_t pendulum_raw = as5600_pendulum.readAngle();
        pendulumZeroAngle = (pendulum_raw * 360.0) / 4096.0;
        
        // Read and set motor sensor zero
        uint16_t motor_raw = readAS5600Angle(motorWire);
        motorZeroAngle = (motor_raw * 360.0) / 4096.0;
        
        Serial.println("\n✓ ZERO POSITION SET!");
        Serial.print("  Pendulum zero: ");
        Serial.print(pendulumZeroAngle, 2);
        Serial.println("°");
        Serial.print("  Motor zero: ");
        Serial.print(motorZeroAngle, 2);
        Serial.println("°");
        Serial.println("  Stepper position: 0 steps");
        
        delay(2000);
        return;
      } else if (c == 'x' || c == 'X') {
        Serial.println("\nCancelled.");
        delay(1000);
        return;
      }
    }
    delay(50);
  }
}

void liveSensorTest() {
  Serial.println("\n╔════════════════════════════════════════════╗");
  Serial.println("║      STEP 2: LIVE SENSOR READINGS          ║");
  Serial.println("╚════════════════════════════════════════════╝");
  Serial.println("\nManually rotate the pendulum and motor arm.");
  Serial.println("Verify both sensors respond correctly.");
  Serial.println("Press 'S' to stop.\n");
  Serial.println("─────────────────────────────────────────────");
  Serial.println("Pendulum (°) \t Motor (°) \t Steps");
  Serial.println("─────────────────────────────────────────────");
  
  unsigned long lastPrint = millis();
  
  while (true) {
    if (Serial.available() > 0) {
      char c = Serial.read();
      if (c == 's' || c == 'S' || c == 'x' || c == 'X') {
        Serial.println("─────────────────────────────────────────────");
        Serial.println("Sensor test stopped.\n");
        delay(1000);
        return;
      }
    }
    
    if (millis() - lastPrint >= 100) {
      lastPrint = millis();
      printSensorReadings();
    }
  }
}

void recordLeftEdge() {
  Serial.println("\n╔════════════════════════════════════════════╗");
  Serial.println("║     STEP 3a: RECORD LEFT EDGE LIMIT        ║");
  Serial.println("╚════════════════════════════════════════════╝");
  Serial.println("\nINSTRUCTIONS:");
  Serial.println("1. MANUALLY move the motor arm to the LEFT edge");
  Serial.println("   (the leftmost position before hitting something)");
  Serial.println("2. Press 'L' to record this position");
  Serial.println("3. Press 'X' to cancel\n");
  
  Serial.println("Current motor angle:");
  
  unsigned long lastPrint = millis();
  
  while (true) {
    if (millis() - lastPrint >= 200) {
      lastPrint = millis();
      updateSensorReadings();
      Serial.print("  Motor: ");
      Serial.print(motorAngle, 2);
      Serial.print("°  (Steps: ");
      Serial.print(motorSteps);
      Serial.println(")");
    }
    
    if (Serial.available() > 0) {
      char c = Serial.read();
      if (c == 'l' || c == 'L') {
        updateSensorReadings();
        motorMinAngle = motorAngle;
        Serial.println("\n✓ LEFT EDGE RECORDED!");
        Serial.print("  Angle: ");
        Serial.print(motorMinAngle, 2);
        Serial.println("°");
        delay(2000);
        return;
      } else if (c == 'x' || c == 'X') {
        Serial.println("\nCancelled.");
        delay(1000);
        return;
      }
    }
  }
}

void recordRightEdge() {
  Serial.println("\n╔════════════════════════════════════════════╗");
  Serial.println("║    STEP 3b: RECORD RIGHT EDGE LIMIT        ║");
  Serial.println("╚════════════════════════════════════════════╝");
  Serial.println("\nINSTRUCTIONS:");
  Serial.println("1. MANUALLY move the motor arm to the RIGHT edge");
  Serial.println("   (the rightmost position before hitting something)");
  Serial.println("2. Press 'R' to record this position");
  Serial.println("3. Press 'X' to cancel\n");
  
  Serial.println("Current motor angle:");
  
  unsigned long lastPrint = millis();
  
  while (true) {
    if (millis() - lastPrint >= 200) {
      lastPrint = millis();
      updateSensorReadings();
      Serial.print("  Motor: ");
      Serial.print(motorAngle, 2);
      Serial.print("°  (Steps: ");
      Serial.print(motorSteps);
      Serial.println(")");
    }
    
    if (Serial.available() > 0) {
      char c = Serial.read();
      if (c == 'r' || c == 'R') {
        updateSensorReadings();
        motorMaxAngle = motorAngle;
        isCalibrated = true;
        Serial.println("\n✓ RIGHT EDGE RECORDED!");
        Serial.print("  Angle: ");
        Serial.print(motorMaxAngle, 2);
        Serial.println("°");
        Serial.println("\n✓ CALIBRATION COMPLETE!");
        printCalibrationData();
        delay(3000);
        return;
      } else if (c == 'x' || c == 'X') {
        Serial.println("\nCancelled.");
        delay(1000);
        return;
      }
    }
  }
}

void testMotorWithinLimits() {
  if (!isCalibrated) {
    Serial.println("\nERROR: Please calibrate edges first (steps 3-4)!");
    delay(2000);
    return;
  }
  
  Serial.println("\n╔════════════════════════════════════════════╗");
  Serial.println("║   STEP 4: TEST MOTOR WITHIN LIMITS         ║");
  Serial.println("╚════════════════════════════════════════════╝");
  Serial.println("\nMotor will move to each edge and return to center.");
  Serial.println("Press 'S' anytime to STOP.\n");
  
  // Convert angles to approximate steps (you'll need to calibrate this ratio)
  // For now, we'll use current position as reference
  updateSensorReadings();
  long centerSteps = motorSteps;
  
  Serial.println("Moving to LEFT edge...");
  // Move slowly towards left while checking angle
  while (motorAngle > motorMinAngle + 5.0) {  // Stop 5° before edge
    stepper.move(-10);
    stepper.runToPosition();
    updateSensorReadings();
    
    if (Serial.available() > 0) {
      Serial.println("\nSTOPPED by user.");
      return;
    }
  }
  Serial.print("Reached left position: ");
  Serial.print(motorAngle, 2);
  Serial.println("°");
  delay(1000);
  
  Serial.println("Moving to RIGHT edge...");
  while (motorAngle < motorMaxAngle - 5.0) {  // Stop 5° before edge
    stepper.move(10);
    stepper.runToPosition();
    updateSensorReadings();
    
    if (Serial.available() > 0) {
      Serial.println("\nSTOPPED by user.");
      return;
    }
  }
  Serial.print("Reached right position: ");
  Serial.print(motorAngle, 2);
  Serial.println("°");
  delay(1000);
  
  Serial.println("Returning to center...");
  stepper.moveTo(centerSteps);
  stepper.runToPosition();
  
  Serial.println("✓ Test complete!\n");
  delay(2000);
}

void manualJogCW() {
  Serial.println("Jogging CW (+50 steps)...");
  stepper.move(50);
  stepper.runToPosition();
  updateSensorReadings();
  printSensorReadings();
  delay(500);
}

void manualJogCCW() {
  Serial.println("Jogging CCW (-50 steps)...");
  stepper.move(-50);
  stepper.runToPosition();
  updateSensorReadings();
  printSensorReadings();
  delay(500);
}

void returnToZero() {
  Serial.println("Returning to zero position...");
  stepper.moveTo(0);
  stepper.runToPosition();
  updateSensorReadings();
  Serial.println("✓ At zero position");
  printSensorReadings();
  delay(1000);
}

void runI2CScan() {
  Serial.println("\n╔════════════════════════════════════════════╗");
  Serial.println("║           I2C BUS SCANNER                  ║");
  Serial.println("╚════════════════════════════════════════════╝");
  
  Serial.println("\n--- Hardware I2C (pins 20/21) ---");
  byte hw_count = 0;
  for (byte addr = 1; addr < 127; addr++) {
    Wire.beginTransmission(addr);
    if (Wire.endTransmission() == 0) {
      Serial.print("  Device at 0x");
      if (addr < 16) Serial.print("0");
      Serial.print(addr, HEX);
      if (addr == 0x36) Serial.print(" (AS5600)");
      Serial.println();
      hw_count++;
    }
  }
  if (hw_count == 0) Serial.println("  No devices found!");
  
  Serial.println("\n--- Software I2C (pins 22/24) ---");
  byte sw_count = 0;
  for (byte addr = 1; addr < 127; addr++) {
    motorWire.beginTransmission(addr);
    if (motorWire.endTransmission() == 0) {
      Serial.print("  Device at 0x");
      if (addr < 16) Serial.print("0");
      Serial.print(addr, HEX);
      if (addr == 0x36) Serial.print(" (AS5600)");
      Serial.println();
      sw_count++;
    }
  }
  if (sw_count == 0) Serial.println("  No devices found!");
  
  Serial.println("\n✓ Scan complete\n");
  delay(2000);
}

void clearCalibration() {
  Serial.println("\nClearing all calibration data...");
  pendulumZeroAngle = 0.0;
  motorZeroAngle = 0.0;
  motorMinAngle = 0.0;
  motorMaxAngle = 0.0;
  isCalibrated = false;
  Serial.println("✓ Calibration cleared\n");
  delay(1000);
}

void setup() {
  Serial.begin(115200);
  delay(2000);
  
  Serial.println("\n\n");
  Serial.println("╔════════════════════════════════════════════╗");
  Serial.println("║  ROTARY INVERTED PENDULUM CALIBRATION      ║");
  Serial.println("║         Step-by-Step Setup                 ║");
  Serial.println("╚════════════════════════════════════════════╝");
  Serial.println();
  
  // Setup motor
  pinMode(EN_PIN, OUTPUT);
  digitalWrite(EN_PIN, LOW);
  stepper.setMaxSpeed(MOTOR_SPEED);
  stepper.setAcceleration(MOTOR_ACCEL);
  stepper.setCurrentPosition(0);
  Serial.println("[OK] Motor Driver Enabled");
  
  // Setup Hardware I2C (Pendulum)
  Wire.begin();
  delay(100);
  as5600_pendulum.begin();
  if (!as5600_pendulum.detectMagnet()) {
    Serial.println("[ERROR] Pendulum Sensor not detected!");
  } else {
    Serial.println("[OK] Pendulum Sensor Connected (HW I2C)");
  }
  
  // Setup Software I2C (Motor)
  motorWire.begin();
  motorWire.setClock(100000);
  delay(100);
  if (!detectAS5600Magnet(motorWire)) {
    Serial.println("[ERROR] Motor Sensor not detected!");
  } else {
    Serial.println("[OK] Motor Sensor Connected (SW I2C)");
  }
  
  Serial.println("\n════════════════════════════════════════════\n");
  delay(1000);
  
  printMainMenu();
}

void loop() {
  if (Serial.available() > 0) {
    char c = Serial.read();
    
    // Skip newlines
    if (c == '\n' || c == '\r') {
      return;
    }
    
    switch (c) {
      case '1':
        setZeroPosition();
        printMainMenu();
        break;
        
      case '2':
        liveSensorTest();
        printMainMenu();
        break;
        
      case '3':
        recordLeftEdge();
        printMainMenu();
        break;
        
      case '4':
        recordRightEdge();
        printMainMenu();
        break;
        
      case '5':
        printCalibrationData();
        delay(2000);
        printMainMenu();
        break;
        
      case '6':
        testMotorWithinLimits();
        printMainMenu();
        break;
        
      case '7':
        manualJogCW();
        printMainMenu();
        break;
        
      case '8':
        manualJogCCW();
        printMainMenu();
        break;
        
      case '9':
        returnToZero();
        printMainMenu();
        break;
        
      case '0':
        runI2CScan();
        printMainMenu();
        break;
        
      case 'c':
      case 'C':
        clearCalibration();
        printMainMenu();
        break;
        
      case 's':
      case 'S':
        Serial.println("Stop command (only works during operations)");
        delay(500);
        break;
        
      default:
        Serial.println("Invalid choice. Try again.");
        delay(500);
        printMainMenu();
        break;
    }
  }
}
