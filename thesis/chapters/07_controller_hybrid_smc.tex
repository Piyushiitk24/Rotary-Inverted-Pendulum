\chapter{Hybrid Sliding Mode Controller}
\label{ch:smc}

\section{Nonlinear upright dynamics (acceleration input)}
The hybrid nonlinear controller uses the exact (nonlinear) upright relation derived from the Euler--Lagrange equations (Chapter~\ref{ch:modelling}), written directly in the acceleration-input form $u\equiv\ddot{\theta}$:
\begin{equation}
\ddot{\alpha}
=
A\sin\alpha
\;+\;
\sin\alpha\cos\alpha\,\dot{\theta}^2
\;-\;
B\cos\alpha\,\ddot{\theta}.
\label{eq:smc_nonlinear_relation}
\end{equation}
The constants $A$ and $B$ are identified for this rig (Chapter~\ref{ch:modelling}). Numerically,
\[
A=100.8\ \text{rad/s}^2,\qquad B=1.952.
\]
This model explicitly captures the gravity term $A\sin\alpha$ and the centrifugal coupling term $\sin\alpha\cos\alpha\,\dot{\theta}^2$.

\section{Sliding surface and desired motion on the surface}
Define the (pendulum-only) sliding surface
\begin{equation}
s \;\equiv\; \dot{\alpha} + \lambda\,\alpha,\qquad \lambda>0.
\label{eq:smc_surface}
\end{equation}
On the surface $s=0$,
\[
\dot{\alpha}=-\lambda\alpha \quad\Rightarrow\quad \alpha(t)=\alpha_0 e^{-\lambda t},
\]
so $\lambda$ sets the upright convergence time constant $1/\lambda$ in the sliding phase.

\section{Surface dynamics and equivalent control}
Differentiating \eqref{eq:smc_surface} gives $\dot{s}=\ddot{\alpha}+\lambda\dot{\alpha}$. Substituting \eqref{eq:smc_nonlinear_relation} yields
\begin{equation}
\dot{s}
=
\Bigl(A\sin\alpha+\sin\alpha\cos\alpha\,\dot{\theta}^2+\lambda\dot{\alpha}\Bigr)
-\;B\cos\alpha\,\ddot{\theta}.
\label{eq:smc_sdot}
\end{equation}
Define the drift term
\[
f(\alpha,\dot{\alpha},\dot{\theta}) \equiv A\sin\alpha+\sin\alpha\cos\alpha\,\dot{\theta}^2+\lambda\dot{\alpha},
\]
so that \eqref{eq:smc_sdot} becomes $\dot{s}=f-B\cos\alpha\,\ddot{\theta}$. The equivalent control (maintaining $\dot{s}=0$) is
\begin{equation}
\ddot{\theta}_{\mathrm{eq}}=\frac{f}{B\cos\alpha}.
\label{eq:smc_eq_control}
\end{equation}

\section{Reaching law, boundary layer, and complete control law}
An ideal reaching law uses a discontinuous sign term, $\dot{s}=-K\,\mathrm{sgn}(s)$, but on real hardware this can induce chattering near $s=0$. Therefore, the implemented controller uses a boundary layer via a saturation function \cite{utkin1992,slotine1991}:
\begin{equation}
\dot{s} = -K\,\mathrm{sat}\!\left(\frac{s}{\phi}\right),\qquad K>0,\ \phi>0,
\label{eq:smc_reaching_law}
\end{equation}
where
\[
\mathrm{sat}(x)=
\begin{cases}
 +1, & x>1\\
 x, & |x|\le 1\\
 -1, & x<-1.
\end{cases}
\]
Substituting \eqref{eq:smc_reaching_law} into $\dot{s}=f-B\cos\alpha\,\ddot{\theta}$ gives the hybrid SMC acceleration command:
\begin{equation}
\ddot{\theta}
=
\frac{f(\alpha,\dot{\alpha},\dot{\theta}) + K\,\mathrm{sat}\!\left(\dfrac{s}{\phi}\right)}{B\cos\alpha}.
\label{eq:smc_control_law}
\end{equation}
Outside the boundary layer ($|s|>\phi$), $\mathrm{sat}(s/\phi)=\mathrm{sgn}(s)$ and reaching is finite-time. Inside ($|s|\le\phi$), $\dot{s}=-(K/\phi)s$ gives exponential decay of $s$.

\section{Lyapunov reaching argument}
Let the Lyapunov candidate be
\[
V(s)=\frac{1}{2}s^2,\qquad V\ge 0.
\]
Using the reaching law \eqref{eq:smc_reaching_law},
\[
\dot{V}=s\dot{s}=-K\,s\,\mathrm{sat}\!\left(\frac{s}{\phi}\right).
\]
Because $s\,\mathrm{sat}(s/\phi)\ge 0$ for all $s$, it follows that $\dot{V}\le 0$, with strict negativity for $|s|>\phi$.

\paragraph{Finite-time reaching to the boundary layer ($|s|>\phi$).}
For $|s|>\phi$, $\mathrm{sat}(s/\phi)=\mathrm{sgn}(s)$ and therefore $\dot{s}=-K\,\mathrm{sgn}(s)$. If $s_0>\phi$ then $s(t)=s_0-Kt$ and the trajectory reaches $s=\phi$ at $t_r=(s_0-\phi)/K$. If $s_0<-\phi$ then $s(t)=s_0+Kt$ and the trajectory reaches $s=-\phi$ at $t_r=(|s_0|-\phi)/K$. Thus the boundary layer is reached in finite time
\[
t_r=\frac{|s_0|-\phi}{K},\qquad |s_0|>\phi.
\]

\paragraph{Convergence within the boundary layer ($|s|\le\phi$).}
For $|s|\le\phi$, $\mathrm{sat}(s/\phi)=s/\phi$ and $\dot{s}=-(K/\phi)s$, so
\[
s(t)=s(t_r)\exp\!\left(-\frac{K}{\phi}(t-t_r)\right),
\qquad
\dot{V}=-(2K/\phi)\,V.
\]

\paragraph{Pendulum decay on the sliding manifold.}
On $s=0$, \eqref{eq:smc_surface} gives $\dot{\alpha}=-\lambda\alpha$, hence $\alpha(t)=\alpha(t_0)e^{-\lambda(t-t_0)}$ and $\lambda$ sets the sliding-phase time constant.

\section{Stepper-oriented implementation constraints}
The law \eqref{eq:smc_control_law} contains $\cos\alpha$ in the denominator. This project is explicitly upright-only (no swing-up), and the implementation enforces:
\begin{itemize}
  \item \textbf{Upright-only validity window}: hard abort if $|\alpha|>\texttt{SMC\_ALPHA\_ABORT\_DEG}=\SI{25}{\degree}$.
  \item \textbf{Cosine guard (``cosine floor'')}: use $\cos_{\mathrm{safe}}=\mathrm{sgn}(\cos\alpha)\max(|\cos\alpha|,\texttt{SMC\_COS\_MIN})$ with \texttt{SMC\_COS\_MIN}=0.2.
  \item \textbf{Extreme-rate abort}: hard abort if $|\dot{\alpha}|>\texttt{SMC\_ALPHADOT\_ABORT\_DEG\_S}=\SI{250}{\degree\per\second}$ for \texttt{SMC\_ALPHADOT\_ABORT\_TICKS\_REQ}=3 consecutive control ticks (after \texttt{SMC\_ABORT\_GRACE\_MS}=\SI{200}{ms} post-engage grace, and only when $|\alpha|>\texttt{SMC\_ALPHADOT\_ABORT\_MIN\_ALPHA\_DEG}=\SI{5}{\degree}$).
  \item \textbf{Acceleration clamp}: the computed $\ddot{\theta}$ is clamped before conversion using \texttt{MAX\_ACC\_STEPS}=\SI{20000}{\step\per\second\squared} and \texttt{STEPS\_PER\_DEG}=4.444 (equivalently, $|\ddot{\theta}|\le \texttt{MAX\_ACC\_STEPS}/\texttt{STEPS\_PER\_DEG}\approx \SI{4500}{\degree\per\second\squared}$ before conversion).
\end{itemize}
The nonlinear computations use $\sin(\alpha)$ and $\cos(\alpha)$ with $\alpha$ interpreted in radians; angles are recorded and plotted in degrees for readability (Chapter~\ref{ch:notation}).

\section{Base-centering assist term (why this controller is ``hybrid'')}
The surface \eqref{eq:smc_surface} stabilizes the pendulum but does not directly regulate the base angle. On a stepper-driven actuator, small unmodeled biases can cause a slow base random-walk even while balancing upright. Therefore, the hybrid controller adds a gated secondary objective: a base reference-tracking acceleration
\begin{equation}
\ddot{\theta}_{\mathrm{base}}
=
\ddot{\theta}_{\mathrm{ref}}
 + k_{\theta}\,(\theta_{\mathrm{ref}}-\theta)
 + k_{\dot{\theta}}\,(\dot{\theta}_{\mathrm{ref}}-\dot{\theta}),
\label{eq:smc_base_assist}
\end{equation}
scaled by a factor $\gamma$ and enabled only when the pendulum is near upright. The total command in stepper acceleration units is
\[
u_{\mathrm{cmd}} \;=\; u_{\mathrm{smc}} + \gamma\,u_{\mathrm{base}},
\]
where $u_{\mathrm{smc}}$ is \eqref{eq:smc_control_law} and $u_{\mathrm{base}}$ corresponds to \eqref{eq:smc_base_assist} expressed in the same units. This structure preserves nonlinear robustness during recovery while providing a practical centering mechanism when conditions are safe.

In firmware, the centering assist is scaled by \texttt{smcBaseScale} (default $\gamma=1.0$, range $0\ldots 2$) and gated by an upright/still window: it is enabled only after a post-engage grace of \SI{200}{ms} and when $|\alpha|<\texttt{SMC\_BASE\_GATE\_ALPHA\_WINDOW\_DEG}=\SI{5}{\degree}$ and $|\dot{\alpha}|<\texttt{SMC\_BASE\_GATE\_ALPHADOT\_WINDOW\_DEG\_S}=\SI{150}{\degree\per\second}$.

\section{Parameters used in experiments}
For the dataset analyzed in Chapter~\ref{ch:results}, the hybrid SMC used:
\begin{table}[htbp]
  \centering
  \small
  \setlength{\tabcolsep}{5pt}
  \caption{Hybrid sliding mode controller parameters used in experiments.}
  \label{tab:smc_params}
  \begin{tabular}{lrl}
    \toprule
    Parameter & Value & Meaning \\
    \midrule
    $\lambda$ & 15\ \si{s^{-1}} & sliding surface slope in \eqref{eq:smc_surface} \\
    $K$ & 800\ \si{\degree\per\second\squared} & reaching gain in \eqref{eq:smc_reaching_law} \\
    $\phi$ & 50\ \si{\degree\per\second} & boundary layer thickness \\
    $\gamma$ & 1.0 & base-centering scale (assist term) \\
    \midrule
    $|\alpha|$ validity & \SI{25}{\degree} & upright-only nonlinear validity window \\
    $|\dot{\alpha}|$ abort & \SI{250}{\degree\per\second} & extreme-rate protection (debounced) \\
    \bottomrule
  \end{tabular}
\end{table}
The base-centering gains $(k_\theta,k_{\dot{\theta}})$ are shared with the linear controller (Table~\ref{tab:lin_gains}) and are gated by an upright/still window so as not to fight recovery.

\ObservedBox{See Figures~\ref{fig:hold_smc_timeseries}, \ref{fig:tap_smc_timeseries} and Tables in Chapter~\ref{ch:results}.}
