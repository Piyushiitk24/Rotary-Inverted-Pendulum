\chapter{Full-Surface Sliding Mode Controller (Four-State Surface)}
\label{ch:smc4}

\section{Reference-tracking coordinates}
All base terms are defined relative to a reference trajectory $\theta_{\mathrm{ref}}(t)$ (generated by the commanded ``nudge'' profile in this project). Define tracking errors
\[
\theta_{\mathrm{err}} \equiv \mathrm{diff}(\theta,\theta_{\mathrm{ref}}),\qquad
\dot{\theta}_{\mathrm{err}} \equiv \dot{\theta} - \dot{\theta}_{\mathrm{ref}},
\]
and note that
\[
\ddot{\theta}_{\mathrm{err}} = \ddot{\theta} - \ddot{\theta}_{\mathrm{ref}}.
\]
The wrap-safe operator $\mathrm{diff}(\cdot,\cdot)$ is defined in Chapter~\ref{ch:notation}.

\section{Full-state sliding surface}
The full-surface controller augments the pendulum sliding surface with a base-centering term:
\begin{equation}
s \equiv \dot{\alpha} + \lambda_{\alpha}\alpha
  + k\Bigl(\dot{\theta}_{\mathrm{err}} + \lambda_{\theta}\theta_{\mathrm{err}}\Bigr),
\label{eq:smc4_surface}
\end{equation}
with design parameters $\lambda_{\alpha}>0$, $\lambda_{\theta}>0$ and coupling weight $k\ge 0$. For $k=0$, \eqref{eq:smc4_surface} reduces to the pendulum-only surface used in Chapter~\ref{ch:smc}.

\section{Surface dynamics and control effectiveness}
Differentiating \eqref{eq:smc4_surface} gives
\begin{equation}
\dot{s} = \ddot{\alpha} + \lambda_{\alpha}\dot{\alpha}
        + k\ddot{\theta}_{\mathrm{err}} + k\lambda_{\theta}\dot{\theta}_{\mathrm{err}}.
\label{eq:smc4_sdot_start}
\end{equation}
Using $\ddot{\theta}_{\mathrm{err}}=\ddot{\theta}-\ddot{\theta}_{\mathrm{ref}}$ and substituting the nonlinear relation \eqref{eq:smc_nonlinear_relation} yields
\begin{equation}
\dot{s}
=
\underbrace{\Bigl(A\sin\alpha+\sin\alpha\cos\alpha\,\dot{\theta}^2\Bigr)}_{\triangleq f_0(\alpha,\dot{\theta})}
\;+\;
\lambda_{\alpha}\dot{\alpha}
\;+\;
k\lambda_{\theta}\dot{\theta}_{\mathrm{err}}
\;-\;
k\ddot{\theta}_{\mathrm{ref}}
\;+\;
(k-B\cos\alpha)\ddot{\theta}.
\label{eq:smc4_sdot}
\end{equation}
Define the full drift term
\[
f_{\mathrm{full}} \equiv f_0(\alpha,\dot{\theta})
 + \lambda_{\alpha}\dot{\alpha}
 + k\lambda_{\theta}\dot{\theta}_{\mathrm{err}}
 - k\ddot{\theta}_{\mathrm{ref}},
\]
so that \eqref{eq:smc4_sdot} becomes
\[
\dot{s} = f_{\mathrm{full}} + (k-B\cos\alpha)\ddot{\theta}.
\]
The control effectiveness depends on the factor $(B\cos\alpha-k)$: if $k$ approaches $B\cos\alpha$, the controller becomes ill-conditioned (large accelerations are required to achieve a given $\dot{s}$). Therefore, the implementation enforces $k$ limits and a denominator margin (Section~\ref{sec:smc4_safeguards}).

\section{Reaching law and complete control law}
As in Chapter~\ref{ch:smc}, use the boundary-layer reaching law
\[
\dot{s} = -K\,\mathrm{sat}\!\left(\frac{s}{\phi}\right),\qquad K>0,\ \phi>0.
\]
Substituting into $\dot{s} = f_{\mathrm{full}} + (k-B\cos\alpha)\ddot{\theta}$ gives
\[
(B\cos\alpha-k)\ddot{\theta}
=
f_{\mathrm{full}} + K\,\mathrm{sat}\!\left(\frac{s}{\phi}\right),
\]
and therefore the full-surface sliding mode control law is
\begin{equation}
\boxed{
\ddot{\theta}
  =
  \frac{
    f_0(\alpha,\dot{\theta})
    + \lambda_{\alpha}\dot{\alpha}
    + k\lambda_{\theta}\dot{\theta}_{\mathrm{err}}
    - k\ddot{\theta}_{\mathrm{ref}}
    + K\,\mathrm{sat}\!\left(\dfrac{s}{\phi}\right)
  }{
    B\cos\alpha - k
  }
}
\label{eq:smc4_control_law}
\end{equation}
with $s$ given by \eqref{eq:smc4_surface}. Setting $k=0$ reduces \eqref{eq:smc4_control_law} to the pendulum-only SMC law \eqref{eq:smc_control_law}.

\section{Lyapunov reaching argument (sketch)}
With $V(s)=\frac{1}{2}s^2$ and $\dot{s}=-K\,\mathrm{sat}(s/\phi)$, one obtains
\[
\dot{V} = -K\,s\,\mathrm{sat}\!\left(\frac{s}{\phi}\right)\le 0,
\]
with finite-time reaching to the boundary layer ($|s|\le\phi$) when $|s|>\phi$, and exponential convergence within the layer. The boundary layer therefore trades discontinuous switching for practical stability (bounded steady-state surface error), as in standard SMC treatments \cite{utkin1992,slotine1991}.

\section{Implementation safeguards and stepper-friendly shaping}
\label{sec:smc4_safeguards}
Compared to the hybrid controller, the full-surface controller is more sensitive to coupling because the term $k$ appears both in the surface and in the denominator $(B\cos\alpha-k)$. To obtain repeatable experiments on a stepper actuator, the implementation enforces:
\begin{itemize}
  \item \textbf{Upright-only validity window} (hard abort) and a \textbf{cosine floor} as a numerical guard.
  \item \textbf{Hard coupling limit} $k\le k_{\max}$ and a \textbf{denominator margin} $B\cos\alpha-k \ge \mathrm{den}_{\min}$, enforced by clamping an effective $k_{\mathrm{eff}}$.
  \item \textbf{Ramp-in of coupling}: $k_{\mathrm{eff}}$ is ramped from 0 to its configured value over a short interval after engage to avoid switch-in transients.
  \item \textbf{Explicit clamps on base error signals} ($\theta_{\mathrm{err}}$, $\dot{\theta}_{\mathrm{err}}$) before they enter the surface to prevent rare glitch/reference-handoff outliers from dominating.
  \item \textbf{Internal $\dot{\alpha}$ clamp} used only inside the SMC computation to limit $\lambda_{\alpha}\dot{\alpha}$-driven spikes, while keeping the separate extreme-rate abort unchanged.
  \item \textbf{Tighter actuator shaping}: in this mode, additional acceleration and speed caps are applied (in addition to global limits) to reduce missed-step ``tick'' events under disturbances.
\end{itemize}

\paragraph{Practical note on centering.}
Although the surface \eqref{eq:smc4_surface} includes base error terms, the stepper-driven system can still benefit from a small gated base-centering assist term of the same PD+FF form as \eqref{eq:smc_base_assist}, scaled by a factor $\gamma$ and enabled only when near upright. This improves repeatability in the presence of friction and modeling mismatch.

\section{Parameters used in experiments}
For the dataset analyzed in Chapter~\ref{ch:results}, the full-surface controller used:
\begin{table}[htbp]
  \centering
  \small
  \setlength{\tabcolsep}{5pt}
  \caption{Full-surface sliding mode controller parameters used in experiments.}
  \label{tab:smc4_params}
  \begin{tabular}{lrl}
    \toprule
    Parameter & Value & Meaning \\
    \midrule
    $\lambda_{\alpha}$ & 15\ \si{s^{-1}} & pendulum surface slope \\
    $K$ & 800\ \si{\degree\per\second\squared} & reaching gain \\
    $\phi$ & 50\ \si{\degree\per\second} & boundary layer thickness \\
    $k$ & 0.50 & base coupling weight in \eqref{eq:smc4_surface} \\
    $\lambda_{\theta}$ & 2.0\ \si{s^{-1}} & base error shaping in \eqref{eq:smc4_surface} \\
    \midrule
    $k_{\max}$ & 1.20 & hard coupling limit \\
    $\mathrm{den}_{\min}$ & 0.60 & minimum denominator margin \\
    coupling ramp & \SI{200}{ms} & ramp-in duration after engage \\
    \bottomrule
  \end{tabular}
\end{table}
As with hybrid SMC, upright-only validity and extreme-rate protections are enabled (Chapter~\ref{ch:hardware}), and the final commanded acceleration is clamped before conversion to stepper units.

\ObservedBox{See Figures~\ref{fig:hold_smc4_timeseries}, \ref{fig:tap_smc4_timeseries} and Tables in Chapter~\ref{ch:results}.}
