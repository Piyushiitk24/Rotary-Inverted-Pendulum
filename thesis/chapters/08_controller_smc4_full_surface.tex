\chapter{Full-Surface Sliding Mode Controller (Four-State Surface)}
\label{ch:smc4}

\section{Base tracking errors}
The base terms in SMC4 are written in tracking-error form so the same controller covers both hold-at-center ($\theta_{\mathrm{ref}}=\mathrm{const}$) and commanded moves (nudge mode, time-varying $\theta_{\mathrm{ref}}$). Define
\[
\theta_{\mathrm{err}} \equiv \mathrm{diff}(\theta,\theta_{\mathrm{ref}}),\qquad
\dot{\theta}_{\mathrm{err}} \equiv \dot{\theta}-\dot{\theta}_{\mathrm{ref}},
\]
with the wrap-safe operator $\mathrm{diff}(\cdot,\cdot)$ from Chapter~\ref{ch:notation}. The reference acceleration $\ddot{\theta}_{\mathrm{ref}}$ appears as a feedforward term in the surface dynamics.

\section{Full-state sliding surface}
The full-surface controller augments the pendulum sliding surface with a base-centering term:
\begin{equation}
s \equiv \dot{\alpha} + \lambda_{\alpha}\alpha
  + k\Bigl(\dot{\theta}_{\mathrm{err}} + \lambda_{\theta}\theta_{\mathrm{err}}\Bigr),
\label{eq:smc4_surface}
\end{equation}
with design parameters $\lambda_{\alpha}>0$, $\lambda_{\theta}>0$ and coupling weight $k\ge 0$. For $k=0$, \eqref{eq:smc4_surface} reduces to the pendulum-only surface used in Chapter~\ref{ch:smc}.

\section{Surface dynamics and control effectiveness}
Differentiating \eqref{eq:smc4_surface} gives
\begin{equation}
\dot{s} = \ddot{\alpha} + \lambda_{\alpha}\dot{\alpha}
        + k\ddot{\theta}_{\mathrm{err}} + k\lambda_{\theta}\dot{\theta}_{\mathrm{err}}.
\label{eq:smc4_sdot_start}
\end{equation}
Using $\ddot{\theta}_{\mathrm{err}}=\ddot{\theta}-\ddot{\theta}_{\mathrm{ref}}$ and substituting the nonlinear relation \eqref{eq:smc_nonlinear_relation} yields
\begin{equation}
\dot{s}
=
\underbrace{\Bigl(A\sin\alpha+\sin\alpha\cos\alpha\,\dot{\theta}^2\Bigr)}_{\triangleq f_0(\alpha,\dot{\theta})}
\;+\;
\lambda_{\alpha}\dot{\alpha}
\;+\;
k\lambda_{\theta}\dot{\theta}_{\mathrm{err}}
\;-\;
k\ddot{\theta}_{\mathrm{ref}}
\;+\;
(k-B\cos\alpha)\ddot{\theta}.
\label{eq:smc4_sdot}
\end{equation}
Define the full drift term
\[
f_{\mathrm{full}} \equiv f_0(\alpha,\dot{\theta})
 + \lambda_{\alpha}\dot{\alpha}
 + k\lambda_{\theta}\dot{\theta}_{\mathrm{err}}
 - k\ddot{\theta}_{\mathrm{ref}},
\]
so that \eqref{eq:smc4_sdot} becomes
\[
\dot{s} = f_{\mathrm{full}} + (k-B\cos\alpha)\ddot{\theta}.
\]
The control effectiveness depends on the factor $(B\cos\alpha-k)$: if $k$ approaches $B\cos\alpha$, the controller becomes ill-conditioned (large accelerations are required to achieve a given $\dot{s}$). Therefore, the implementation enforces $k$ limits and a denominator margin (Section~\ref{sec:smc4_safeguards}).
Because upright-only operation enforces $|\alpha|<\SI{25}{\degree}$, $\cos\alpha \ge \cos(25^\circ)\approx 0.91$. With $B\approx 1.95$ and the nominal choice $k=0.50$, the nominal denominator satisfies $B\cos\alpha-k \gtrsim 1.27$, i.e., comfortably away from the singularity even before applying the additional margin enforcement.

\section{Reaching law and complete control law}
As in Chapter~\ref{ch:smc}, use the boundary-layer reaching law
\[
\dot{s} = -K\,\mathrm{sat}\!\left(\frac{s}{\phi}\right),\qquad K>0,\ \phi>0.
\]
Substituting into $\dot{s} = f_{\mathrm{full}} + (k-B\cos\alpha)\ddot{\theta}$ gives
\[
(B\cos\alpha-k)\ddot{\theta}
=
f_{\mathrm{full}} + K\,\mathrm{sat}\!\left(\frac{s}{\phi}\right),
\]
and therefore the full-surface sliding mode control law is
\begin{equation}
\boxed{
\ddot{\theta}
  =
  \frac{
    f_0(\alpha,\dot{\theta})
    + \lambda_{\alpha}\dot{\alpha}
    + k\lambda_{\theta}\dot{\theta}_{\mathrm{err}}
    - k\ddot{\theta}_{\mathrm{ref}}
    + K\,\mathrm{sat}\!\left(\dfrac{s}{\phi}\right)
  }{
    B\cos\alpha - k
  }
}
\label{eq:smc4_control_law}
\end{equation}
with $s$ given by \eqref{eq:smc4_surface}. Setting $k=0$ reduces \eqref{eq:smc4_control_law} to the pendulum-only SMC law \eqref{eq:smc_control_law}.

\section{Lyapunov reaching argument}
Let $V(s)=\frac{1}{2}s^2$. With the reaching law $\dot{s}=-K\,\mathrm{sat}(s/\phi)$,
\[
\dot{V}=s\dot{s}=-K\,s\,\mathrm{sat}\!\left(\frac{s}{\phi}\right)\le 0,
\]
with strict negativity for $|s|>\phi$.

\paragraph{Finite-time reaching to the boundary layer ($|s|>\phi$).}
For $|s|>\phi$, $\mathrm{sat}(s/\phi)=\mathrm{sgn}(s)$ and $\dot{s}=-K\,\mathrm{sgn}(s)$. Therefore $|s(t)|$ decreases linearly until it reaches $\phi$, and the reaching time satisfies
\[
t_r=\frac{|s_0|-\phi}{K},\qquad |s_0|>\phi.
\]

\paragraph{Convergence within the boundary layer ($|s|\le\phi$).}
For $|s|\le\phi$, $\mathrm{sat}(s/\phi)=s/\phi$ and $\dot{s}=-(K/\phi)s$, so
\[
s(t)=s(t_r)\exp\!\left(-\frac{K}{\phi}(t-t_r)\right),
\qquad
\dot{V}=-(2K/\phi)\,V.
\]
Thus $s(t)\to 0$ exponentially once within the boundary layer, providing practical stability with reduced chattering \cite{utkin1992,slotine1991}.

\section{Implementation safeguards and stepper-friendly shaping}
\label{sec:smc4_safeguards}
Compared to the hybrid controller, the full-surface controller is more sensitive to coupling because the term $k$ appears both in the surface and in the denominator $(B\cos\alpha-k)$. To obtain repeatable experiments on a stepper actuator, the implementation enforces:
\begin{itemize}
  \item \textbf{Upright-only validity and cosine guard}: enforce $|\alpha|<\SI{25}{\degree}$ (upright-only) and use a cosine floor \texttt{SMC\_COS\_MIN}=0.2 via $\cos_{\mathrm{safe}}=\mathrm{sgn}(\cos\alpha)\max(|\cos\alpha|,\texttt{SMC\_COS\_MIN})$.
  \item \textbf{Hard coupling limit}: clamp the requested coupling to $k\le \texttt{SMC\_FULL\_K\_MAX}=1.20$.
  \item \textbf{Denominator margin}: enforce $|B\cos_{\mathrm{safe}}-k_{\mathrm{eff}}|\ge \texttt{SMC\_FULL\_DENOM\_MIN}=0.60$ by clamping an effective $k_{\mathrm{eff}}$ used in \eqref{eq:smc4_control_law}.
  \item \textbf{Ramp-in of coupling}: ramp $k_{\mathrm{eff}}$ from 0 to its configured value over \texttt{SMC\_FULL\_K\_RAMP\_MS}=\SI{200}{ms} after engage.
  \item \textbf{Explicit clamps on base error signals}: clamp $\theta_{\mathrm{err}}$ to $\pm\texttt{SMC\_FULL\_THETA\_ERR\_CLAMP\_DEG}=\pm\SI{78}{\degree}$ and $\dot{\theta}_{\mathrm{err}}$ to $\pm\texttt{SMC\_FULL\_THETADOT\_ERR\_CLAMP\_DEG\_S}=\pm\SI{200}{\degree\per\second}$, and clamp the combined base term to \texttt{SMC\_FULL\_THETA\_TERM\_CLAMP\_DEG\_S}=\SI{300}{\degree\per\second}.
  \item \textbf{Internal $\dot{\alpha}$ clamp}: clamp $\dot{\alpha}$ \emph{inside} the SMC4 computation to $\pm\texttt{SMC4\_ALPHA\_DOT\_CTRL\_CLAMP\_DEG\_S}=\pm\SI{200}{\degree\per\second}$ to limit $\lambda_{\alpha}\dot{\alpha}$-driven spikes (while keeping the separate extreme-rate abort unchanged).
  \item \textbf{Tighter actuator shaping}: apply additional caps \texttt{SMC4\_MAX\_ACC\_STEPS}=\SI{12000}{\step\per\second\squared} and \texttt{SMC4\_MAX\_SPEED\_HZ}=\SI{2000}{\step\per\second} (on top of global limits) to reduce stall/missed-step events under disturbances.
\end{itemize}

\subsection{Gated base-centering assist (implemented)}
Although the surface \eqref{eq:smc4_surface} includes base error terms, the firmware additionally applies the same gated base-centering assist mechanism used in the hybrid controller: the total commanded acceleration is the sum of the SMC4 command and a gated PD+FF base term of the form \eqref{eq:smc_base_assist}. This is a practical contribution for stepper actuation because it prevents slow base random-walk drift while keeping the assist inactive during large recovery transients.

In firmware, the assist is scaled by \texttt{smcBaseScale} (default $\gamma=1.0$, range $0\ldots 2$) and gated only after a post-engage grace of \texttt{MOVE\_ENGAGE\_GRACE\_MS}=\SI{200}{ms}. The gate requires $|\alpha|<\texttt{SMC\_BASE\_GATE\_ALPHA\_WINDOW\_DEG}=\SI{5}{\degree}$ and $|\dot{\alpha}|<\texttt{SMC4\_BASE\_GATE\_ALPHADOT\_WINDOW\_DEG\_S}=\SI{250}{\degree\per\second}$.

\section{Parameters used in experiments}
For the dataset analyzed in Chapter~\ref{ch:results}, the full-surface controller used:
\begin{table}[htbp]
  \centering
  \small
  \setlength{\tabcolsep}{5pt}
  \caption{Full-surface sliding mode controller parameters used in experiments.}
  \label{tab:smc4_params}
  \begin{tabular}{lrl}
    \toprule
    Parameter & Value & Meaning \\
    \midrule
    $\lambda_{\alpha}$ & 15\ \si{s^{-1}} & pendulum surface slope \\
    $K$ & 800\ \si{\degree\per\second\squared} & reaching gain \\
    $\phi$ & 50\ \si{\degree\per\second} & boundary layer thickness \\
    $k$ & 0.50 & base coupling weight in \eqref{eq:smc4_surface} \\
    $\lambda_{\theta}$ & 2.0\ \si{s^{-1}} & base error shaping in \eqref{eq:smc4_surface} \\
    \midrule
    $k_{\max}$ & 1.20 & hard coupling limit \\
    $\mathrm{den}_{\min}$ & 0.60 & minimum denominator margin \\
    coupling ramp & \SI{200}{ms} & ramp-in duration after engage \\
    \bottomrule
  \end{tabular}
\end{table}
As with hybrid SMC, upright-only validity and extreme-rate protections are enabled (Chapter~\ref{ch:hardware}), and the final commanded acceleration is clamped before conversion to stepper units.

\ObservedBox{See Figures~\ref{fig:hold_smc4_timeseries}, \ref{fig:tap_smc4_timeseries} and Tables in Chapter~\ref{ch:results}.}
